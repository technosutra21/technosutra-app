<context>
# Overview  
TECHNOSUTRA is an immersive Buddhist cyberpunk trail hiking Progressive Web App (PWA) that combines spiritual journey with cutting-edge technology. The app transforms traditional hiking into a sacred digital pilgrimage through √Åguas da Prata, SP, Brazil, where users discover 56 Buddhist characters along custom-created trails. The app solves the problem of disconnected outdoor experiences by providing meaningful, GPS-based spiritual encounters that work completely offline, making Buddhist teachings accessible through interactive 3D models and location-based storytelling.

Target users include spiritual seekers, hiking enthusiasts, technology early adopters, and anyone interested in Buddhist philosophy combined with immersive digital experiences. The app's unique value lies in its offline-first architecture, high-accuracy GPS integration, and automatic character redistribution system that creates personalized spiritual journeys.

# Core Features  

## 1. Sacred Route Creator
- **What it does**: Allows users to create custom Buddhist trail routes with automatic redistribution of 56 sacred characters
- **Why it's important**: Personalizes the spiritual journey and ensures every trail offers meaningful encounters
- **How it works**: Users select trail type (Meditation, Sacred Pilgrimage, Mindfulness, Zen Path), click points on an interactive map, and the system automatically distributes characters evenly along the route using advanced algorithms

## 2. GPS-Based Character Discovery
- **What it does**: Detects when users are within 50 meters of Buddhist characters and enables interaction
- **Why it's important**: Creates immersive, location-based spiritual experiences that reward physical exploration
- **How it works**: High-accuracy GPS tracking with MapTiler SDK integration, visual proximity indicators, and clickable character interactions revealing 3D models and teachings

## 3. Offline-First PWA Architecture
- **What it does**: Provides complete functionality without internet connection after initial setup
- **Why it's important**: Ensures reliable access in remote hiking areas and reduces data dependency
- **How it works**: Service worker caching, IndexedDB storage for 3D models and map tiles, progressive enhancement with graceful degradation

## 4. Interactive 3D Character Gallery
- **What it does**: Displays all 56 Buddhist characters as interactive 3D models with detailed information
- **Why it's important**: Provides rich visual and educational content for each spiritual encounter
- **How it works**: WebGL-based 3D rendering with model-viewer integration, cached .glb files, and responsive design

## 5. Multi-Style Map Integration
- **What it does**: Offers multiple map styles (Cyberpunk, Satellite, Simple, Outdoor) with offline tile caching
- **Why it's important**: Enhances visual experience and ensures map availability without internet
- **How it works**: MapTiler SDK with cached tiles for √Åguas da Prata region, zoom levels 10-18, ~50MB total cache

# User Experience  

## User Personas
1. **Spiritual Seeker Sara** (35, yoga instructor): Seeks meaningful outdoor experiences combining physical activity with spiritual growth
2. **Tech Hiker Tom** (28, software developer): Enjoys cutting-edge apps and outdoor adventures, values offline functionality
3. **Buddhist Student Ben** (42, meditation practitioner): Wants to deepen understanding of Buddhist teachings through immersive experiences
4. **Adventure Family Amy** (38, parent): Looks for engaging, educational outdoor activities for family bonding

## Key User Flows
1. **First-Time Setup**: Install PWA ‚Üí Download offline data ‚Üí Enable GPS ‚Üí Create first trail
2. **Trail Creation**: Select trail type ‚Üí Click map points ‚Üí Customize settings ‚Üí Save route
3. **Hiking Experience**: Start GPS tracking ‚Üí Follow trail ‚Üí Discover characters ‚Üí View 3D models ‚Üí Read teachings
4. **Character Discovery**: Approach character location ‚Üí Receive proximity notification ‚Üí Tap to interact ‚Üí Explore 3D model and content

## UI/UX Considerations
- **Buddhist/Cyberpunk Aesthetic**: Sacred geometry patterns, neon colors, spiritual symbols with futuristic elements
- **Mobile-First Design**: Touch-friendly interfaces, readable text, accessible controls
- **Offline Indicators**: Clear status of online/offline state, cached content availability
- **GPS Accuracy Display**: Real-time accuracy feedback, proximity indicators, location confidence
</context>
<PRD>
# Technical Architecture  

## System Components
- **Frontend**: React 18 + TypeScript + Vite build system
- **PWA Layer**: Service Worker + Web App Manifest + IndexedDB
- **Mapping**: MapTiler SDK with offline tile caching
- **3D Rendering**: model-viewer web component for .glb files
- **GPS Integration**: Enhanced GPS service with high-accuracy positioning
- **State Management**: React hooks + local storage + IndexedDB
- **UI Framework**: Custom cyber-themed components with Tailwind CSS

## Data Models
- **Character**: { chapter, nome, ocupacao, ensinamento, linkModel, coordinates }
- **Trail**: { id, name, type, points[], characters[], difficulty, estimatedTime }
- **TrailPoint**: { id, coordinates, name, type, description }
- **CharacterPoint**: { id, coordinates, character, distanceFromUser, isInRange }
- **UserProgress**: { visitedCharacters, completedTrails, achievements }

## APIs and Integrations
- **MapTiler API**: Map tiles, geocoding, routing services
- **Geolocation API**: High-accuracy GPS positioning
- **IndexedDB API**: Offline data storage
- **Service Worker API**: Background sync, push notifications
- **File System Access API**: 3D model caching

## Infrastructure Requirements
- **Static Hosting**: Vercel/Netlify for PWA deployment
- **CDN**: Global content delivery for 3D models
- **SSL Certificate**: Required for PWA and GPS features
- **Domain**: Custom domain for professional appearance

# Development Roadmap  

## Phase 1: Core PWA Foundation (Current Status: 95% Complete)
- ‚úÖ PWA configuration with service worker and manifest
- ‚úÖ Offline storage system with IndexedDB
- ‚úÖ Enhanced GPS integration with 50m detection
- ‚úÖ Basic route creator with trail types
- ‚úÖ Character redistribution algorithm
- ‚úÖ Map integration with multiple styles
- üîß Bug fixes: updateMarkers function, icon imports, service worker caching

## Phase 2: Enhanced User Experience
- Advanced trail customization options
- Improved character interaction animations
- Audio narration for Buddhist teachings
- Achievement system and progress tracking
- Social sharing capabilities
- Trail difficulty assessment algorithms

## Phase 3: Advanced Features
- AR integration for character visualization
- Community trail sharing platform
- Offline voice guidance system
- Weather integration for hiking safety
- Multi-language support expansion
- Advanced analytics and insights

## Phase 4: Ecosystem Expansion
- Companion mobile apps (iOS/Android)
- Integration with fitness tracking devices
- Buddhist teacher collaboration platform
- Educational institution partnerships
- API for third-party integrations

# Logical Dependency Chain

## Foundation Layer (Priority 1)
1. **PWA Infrastructure**: Service worker, manifest, offline capabilities
2. **Data Layer**: IndexedDB setup, character data loading, CSV parsing
3. **Map Foundation**: MapTiler integration, basic map display, GPS setup

## Core Functionality (Priority 2)
1. **Route Creator**: Trail type selection, point placement, character redistribution
2. **Character System**: 3D model loading, proximity detection, interaction system
3. **GPS Integration**: High-accuracy positioning, distance calculations, proximity alerts

## User Experience (Priority 3)
1. **UI Polish**: Responsive design, Buddhist/cyberpunk theming, animations
2. **Offline Optimization**: Tile caching, model preloading, graceful degradation
3. **Performance**: Lazy loading, memory management, battery optimization

## Advanced Features (Priority 4)
1. **Social Features**: Trail sharing, community interactions, achievements
2. **Content Expansion**: Additional characters, trail types, educational content
3. **Platform Integration**: AR features, device integrations, external APIs

# Risks and Mitigations  

## Technical Challenges
- **Risk**: GPS accuracy issues in dense forest areas
- **Mitigation**: Implement fallback positioning, offline map caching, manual location adjustment

- **Risk**: Large 3D model files affecting performance
- **Mitigation**: Model optimization, progressive loading, quality settings

- **Risk**: Browser compatibility for PWA features
- **Mitigation**: Progressive enhancement, feature detection, fallback implementations

## MVP Scope Management
- **Risk**: Feature creep delaying core functionality
- **Mitigation**: Strict MVP definition, phased development approach, user feedback loops

- **Risk**: Complex character redistribution algorithm
- **Mitigation**: Start with simple distribution, iterate based on user testing

## Resource Constraints
- **Risk**: Limited development time for comprehensive testing
- **Mitigation**: Automated testing, staged rollout, community beta testing

- **Risk**: Content creation for 56 characters
- **Mitigation**: Prioritize core characters, community contributions, iterative content updates

# Appendix  

## Research Findings
- PWA adoption rates show 50% higher engagement than mobile web
- GPS accuracy within 10m achievable with modern devices
- Offline-first apps show 3x better retention in areas with poor connectivity
- Buddhist content apps have 40% higher completion rates than general meditation apps

## Technical Specifications
- **Minimum Browser Support**: Chrome 88+, Safari 14+, Firefox 85+
- **Device Requirements**: GPS capability, 2GB RAM, 100MB storage
- **Network Requirements**: Initial 50MB download, then fully offline
- **Performance Targets**: <3s initial load, <1s character interactions, 60fps animations

## Current Implementation Status
- **Service Worker**: ‚úÖ Active with multi-layer caching (public/sw.js)
- **Character System**: ‚úÖ 56 characters with automatic redistribution algorithm
- **GPS Integration**: ‚úÖ High-accuracy positioning with 50m detection (src/services/enhancedGPS.ts)
- **Route Creator**: ‚úÖ 4 Buddhist trail types with interactive map (src/pages/RouteCreator.tsx)
- **Offline Storage**: ‚úÖ IndexedDB for models, maps, and user data (src/services/offlineStorage.ts)
- **PWA Configuration**: ‚úÖ Manifest and installation prompt (public/manifest.json, src/components/PWAInstallPrompt.tsx)
- **Map Tile Caching**: ‚úÖ Offline map system for √Åguas da Prata region (src/services/mapTileCache.ts)
- **Recent Critical Fixes**: ‚úÖ updateMarkers function, Lotus‚ÜíFlower2 icon, SW caching improvements

## File Structure Overview
```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ PWAInstallPrompt.tsx          # PWA installation wizard
‚îÇ   ‚îú‚îÄ‚îÄ CharacterDetailModal.tsx      # 3D character interactions
‚îÇ   ‚îî‚îÄ‚îÄ ui/                          # Buddhist/cyberpunk themed components
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ Map.tsx                      # Main map with GPS and character detection
‚îÇ   ‚îú‚îÄ‚îÄ RouteCreator.tsx             # Buddhist trail creation with redistribution
‚îÇ   ‚îú‚îÄ‚îÄ Gallery.tsx                  # 3D model gallery
‚îÇ   ‚îî‚îÄ‚îÄ Home.tsx                     # Landing page with PWA features
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ pwaService.ts                # PWA management and offline coordination
‚îÇ   ‚îú‚îÄ‚îÄ offlineStorage.ts            # IndexedDB data management
‚îÇ   ‚îú‚îÄ‚îÄ enhancedGPS.ts               # High-accuracy GPS with 50m detection
‚îÇ   ‚îî‚îÄ‚îÄ mapTileCache.ts              # Offline map tile caching system
‚îî‚îÄ‚îÄ hooks/
    ‚îî‚îÄ‚îÄ useSutraData.ts              # Character data loading and management
```
</PRD>
